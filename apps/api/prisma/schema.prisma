generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Users ──────────────────────────────────────────────

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String?
  avatar    String?
  role      String   @default("student")
  bio       String?
  location  String?
  website   String?
  github    String?
  linkedin  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrollments  Enrollment[]
  progress     Progress[]
  certificates Certificate[]
  applications Application[]

  @@map("users")
}

// ─── Courses ────────────────────────────────────────────

model Course {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String
  category    String
  level       String   @default("beginner")
  duration    String
  price       Int      @default(0)
  maxStudents Int      @default(20)
  published   Boolean  @default(false)
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  modules      Module[]
  enrollments  Enrollment[]
  certificates Certificate[]

  @@map("courses")
}

model Module {
  id       String @id @default(cuid())
  courseId  String
  title    String
  weeks    String
  order    Int
  color    String @default("indigo")

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@map("modules")
}

model Lesson {
  id           String  @id @default(cuid())
  moduleId     String
  title        String
  type         String  @default("video")
  duration     String
  order        Int
  content      String?
  videoUrl     String?
  instructor   String?

  module   Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress Progress[]

  @@map("lessons")
}

// ─── Enrollment & Progress ──────────────────────────────

model Enrollment {
  id         String   @id @default(cuid())
  userId     String
  courseId    String
  status     String   @default("active")
  enrolledAt DateTime @default(now())

  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  course   Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress Progress[]

  @@unique([userId, courseId])
  @@map("enrollments")
}

model Progress {
  id               String    @id @default(cuid())
  userId           String
  enrollmentId     String
  lessonId         String
  completed        Boolean   @default(false)
  completedAt      DateTime?
  timeSpentMinutes Int       @default(0)
  score            Int?

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson     Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("progress")
}

// ─── Certificates ───────────────────────────────────────

model Certificate {
  id          String   @id @default(cuid())
  userId      String
  courseId     String
  title       String
  type        String   @default("completion")
  grade       String?
  nftId       String?
  polygonLink String?
  verified    Boolean  @default(false)
  issuedAt    DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("certificates")
}

// ─── Applications ───────────────────────────────────────

model Application {
  id         String   @id @default(cuid())
  userId     String?
  firstName  String
  lastName   String
  email      String
  phone      String?
  degree     String?
  field      String?
  experience String?
  motivation String?
  portfolio  String?
  cohortDate String?
  status     String   @default("pending")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id])

  @@map("applications")
}
